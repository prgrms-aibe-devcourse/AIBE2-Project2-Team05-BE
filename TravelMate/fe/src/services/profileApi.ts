import api from './api';

// í”„ë¡œí•„ íƒ€ì… ì •ì˜ (ë°±ì—”ë“œ ProfileResponseDtoì™€ ë§¤ì¹­)
export interface ProfileData {
  id: number;
  nickname: string;
  email: string;
  bio?: string;
  profileImage?: string;
  age?: number;
  gender?: string;
  followerCount: number;
  followingCount: number;
  postsCount: number;
  createdTripsCount: number;
  joinedTripsCount: number;
  feeds?: any[];
}

/**
 * í”„ë¡œí•„ API ì„œë¹„ìŠ¤ í´ë˜ìŠ¤
 */
class ProfileApiService {
  /**
   * í˜„ì¬ ë¡œê·¸ì¸í•œ ì‚¬ìš©ìì˜ í”„ë¡œí•„ ì¡°íšŒ
   */
  async getMyProfile(): Promise<ProfileData> {
    try {
      console.log('ğŸ‘¤ í˜„ì¬ ì‚¬ìš©ì í”„ë¡œí•„ ì¡°íšŒ ì‹œì‘');

      const response = await api.get<ProfileData>('/api/profile/me');

      console.log('âœ… í˜„ì¬ ì‚¬ìš©ì í”„ë¡œí•„ ì¡°íšŒ ì„±ê³µ:', response.data);
      return response.data;
    } catch (error: any) {
      console.error('âŒ í˜„ì¬ ì‚¬ìš©ì í”„ë¡œí•„ ì¡°íšŒ ì‹¤íŒ¨:', error);

      // ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ ë“±ìœ¼ë¡œ ë°±ì—”ë“œ ì—°ê²° ì‹¤íŒ¨ ì‹œ ê¸°ë³¸ê°’ ë°˜í™˜
      if (!error.response || error.code === 'NETWORK_ERROR') {
        console.warn('ğŸ”„ ë°±ì—”ë“œ ì—°ê²° ì‹¤íŒ¨, ê¸°ë³¸ í”„ë¡œí•„ ë°ì´í„° ë°˜í™˜');
        return this.getDefaultProfile();
      }

      throw new Error(
        `í”„ë¡œí•„ ì¡°íšŒ ì‹¤íŒ¨: ${error.response?.data?.message || error.message}`,
      );
    }
  }

  /**
   * íŠ¹ì • ì‚¬ìš©ìì˜ í”„ë¡œí•„ ì¡°íšŒ
   */
  async getProfile(userId: number): Promise<ProfileData> {
    try {
      console.log('ğŸ‘¤ ì‚¬ìš©ì í”„ë¡œí•„ ì¡°íšŒ ì‹œì‘:', userId);

      const response = await api.get<ProfileData>(`/api/profile/${userId}`);

      console.log('âœ… ì‚¬ìš©ì í”„ë¡œí•„ ì¡°íšŒ ì„±ê³µ:', response.data);
      return response.data;
    } catch (error: any) {
      console.error('âŒ ì‚¬ìš©ì í”„ë¡œí•„ ì¡°íšŒ ì‹¤íŒ¨:', error);

      // ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ ë“±ìœ¼ë¡œ ë°±ì—”ë“œ ì—°ê²° ì‹¤íŒ¨ ì‹œ ê¸°ë³¸ê°’ ë°˜í™˜
      if (!error.response || error.code === 'NETWORK_ERROR') {
        console.warn('ğŸ”„ ë°±ì—”ë“œ ì—°ê²° ì‹¤íŒ¨, ê¸°ë³¸ í”„ë¡œí•„ ë°ì´í„° ë°˜í™˜');
        return this.getDefaultProfile(userId);
      }

      throw new Error(
        `í”„ë¡œí•„ ì¡°íšŒ ì‹¤íŒ¨: ${error.response?.data?.message || error.message}`,
      );
    }
  }

  /**
   * í”„ë¡œí•„ ì—…ë°ì´íŠ¸ (ë‹‰ë„¤ì„ í¬í•¨)
   */
  async updateProfile(profileData: {
    nickname?: string;
    realName?: string;
    age?: number;
    gender?: string;
    preferredDestinations?: string;
    travelStyle?: string;
    bio?: string;
    profileImage?: string;
  }): Promise<void> {
    try {
      console.log('âœï¸ í”„ë¡œí•„ ì—…ë°ì´íŠ¸ ì‹œì‘:', profileData);

      const response = await api.put('/api/profile', profileData);

      console.log('âœ… í”„ë¡œí•„ ì—…ë°ì´íŠ¸ ì„±ê³µ:', response.data);
    } catch (error: any) {
      console.error('âŒ í”„ë¡œí•„ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', error);
      throw new Error(
        `í”„ë¡œí•„ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: ${error.response?.data?.message || error.message}`,
      );
    }
  }

  /**
   * íŒ”ë¡œìš°
   */
  async follow(targetUserId: number): Promise<void> {
    try {
      await api.post(`/api/profile/follow/${targetUserId}`);
      console.log('âœ… íŒ”ë¡œìš° ì„±ê³µ:', targetUserId);
    } catch (error: any) {
      console.error('âŒ íŒ”ë¡œìš° ì‹¤íŒ¨:', error);
      throw new Error(
        `íŒ”ë¡œìš° ì‹¤íŒ¨: ${error.response?.data?.message || error.message}`,
      );
    }
  }

  /**
   * ì–¸íŒ”ë¡œìš°
   */
  async unfollow(targetUserId: number): Promise<void> {
    try {
      await api.delete(`/api/profile/unfollow/${targetUserId}`);
      console.log('âœ… ì–¸íŒ”ë¡œìš° ì„±ê³µ:', targetUserId);
    } catch (error: any) {
      console.error('âŒ ì–¸íŒ”ë¡œìš° ì‹¤íŒ¨:', error);
      throw new Error(
        `ì–¸íŒ”ë¡œìš° ì‹¤íŒ¨: ${error.response?.data?.message || error.message}`,
      );
    }
  }

  /**
   * ë°±ì—”ë“œ ì—°ê²° ì‹¤íŒ¨ ì‹œ ê¸°ë³¸ í”„ë¡œí•„ ë°ì´í„° ë°˜í™˜
   */
  private getDefaultProfile(userId?: number): ProfileData {
    const userEmail = localStorage.getItem('user')
      ? JSON.parse(localStorage.getItem('user') || '{}').email
      : 'user@example.com';

    return {
      id: userId || 1,
      nickname: userEmail.split('@')[0] || 'ì‚¬ìš©ì',
      email: userEmail,
      bio: 'ìê¸°ì†Œê°œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.',
      profileImage: undefined,
      age: 0,
      gender: 'ë¹„ê³µê°œ',
      followerCount: 0,
      followingCount: 0,
      postsCount: 0,
      createdTripsCount: 0,
      joinedTripsCount: 0,
      feeds: [],
    };
  }
}

// ì‹±ê¸€í†¤ ì¸ìŠ¤í„´ìŠ¤ ìƒì„±
const profileApiService = new ProfileApiService();

export default profileApiService;
